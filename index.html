<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEAC3 Asset Hub - ศูนย์รวมข้อมูลทรัพย์สิน กฟก.3</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 0;
            border-radius: 1rem;
            width: 95vw;
            height: 90vh;
            max-width: none;
            max-height: none;
            overflow: hidden;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
         .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f3f4f6;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
         }
        .modal-close {
            cursor: pointer;
        }
        #previewModal iframe {
            width: 100%;
            height: calc(100% - 57px); /* Adjust based on header height */
            border: none;
        }
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            cursor: text;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #e0e7ff;
            color: #3730a3;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
        }
        .tag-remove {
            margin-left: 0.5rem;
            cursor: pointer;
            font-weight: bold;
        }
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #d1d5db;
            background-color: white;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 999;
            border-radius: 0 0 0.75rem 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .autocomplete-suggestion {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f3f4f6;
        }
        .sortable {
            cursor: pointer;
        }
        .sortable:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .sort-icon {
            opacity: 0.5;
            margin-left: 5px;
        }
        .sortable.asc .fa-sort-up,
        .sortable.desc .fa-sort-down {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-r from-purple-500 to-indigo-600">
    <div class="mx-auto px-4 sm:px-6 lg:px-8 max-w-screen-2xl">
        <div class="text-center text-white my-8">
            <h1 class="text-4xl font-semibold mb-2 text-shadow-lg">PEAC3 Asset Hub</h1>
            <p class="text-lg font-medium opacity-90">ศูนย์รวมข้อมูลทรัพย์สิน กฟก.3</p>
        </div>

        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <!-- Search Section -->
            <div class="p-10 text-center" id="searchSection">
                <h2 class="text-3xl font-semibold text-gray-700 mb-8">ค้นหาข้อมูลทรัพย์สิน</h2>
                
                <form class="max-w-4xl mx-auto" id="searchForm">
                    <div class="mb-6">
                        <label class="block text-gray-600 font-medium mb-4">ประเภทการค้นหา:</label>
                        <div class="flex flex-row flex-wrap items-center justify-center gap-x-4 sm:gap-x-6">
                            <div class="flex items-center gap-2">
                                <input type="radio" id="assetNumber" name="searchType" value="assetNumber" class="w-5 h-5 accent-indigo-600" checked>
                                <label for="assetNumber">รหัสทรัพย์สิน</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="radio" id="employee" name="searchType" value="employee" class="w-5 h-5 accent-indigo-600">
                                <label for="employee">รหัสพนักงาน</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="radio" id="costCenterName" name="searchType" value="costCenterName" class="w-5 h-5 accent-indigo-600">
                                <label for="costCenterName">ชื่อศูนย์ต้นทุน</label>
                            </div>
                             <div class="flex items-center gap-2">
                                <input type="radio" id="businessType" name="searchType" value="businessType" class="w-5 h-5 accent-indigo-600">
                                <label for="businessType">ประเภทธุรกิจ</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <label for="searchInput" id="searchLabel" class="block text-gray-600 font-medium mb-2">รหัสทรัพย์สิน:</label>
                        <div id="tagContainer" class="tag-container">
                             <input type="text" 
                                   id="searchInput" 
                                   class="flex-grow p-2 border-0 focus:outline-none focus:ring-0" 
                                   placeholder="กรอกข้อมูลแล้วกด Enter เพื่อเพิ่ม"
                                   autocomplete="off">
                        </div>
                        <div id="suggestionsContainer" class="autocomplete-suggestions hidden"></div>
                    </div>
                    
                    <button type="submit" class="w-full mt-6 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">
                        <i class="fas fa-search"></i> ค้นหา
                    </button>
                </form>
            </div>

            <!-- Loading -->
            <div class="p-10 text-center hidden" id="loading">
                <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full text-indigo-500" role="status"></div>
                <p class="mt-4 text-gray-600">กำลังค้นหาข้อมูล...</p>
            </div>

            <!-- Error Message -->
            <div class="p-4 m-4 bg-red-100 text-red-700 rounded-lg hidden" id="errorMessage"></div>
            
            <!-- Toast Notification -->
            <div id="toast" class="fixed top-5 right-5 bg-yellow-400 text-gray-800 py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 z-50">กรุณาเลือกรายการที่ต้องการ</div>

            <!-- No Results -->
            <div class="p-10 text-center text-gray-500 hidden" id="noResults">
                <i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4"></i>
                <h3 class="text-2xl font-semibold mb-2">ไม่พบข้อมูล</h3>
                <p>ไม่พบข้อมูลที่ตรงกับคำค้นหา กรุณาลองค้นหาใหม่อีกครั้ง</p>
            </div>

            <!-- Results Section -->
            <div class="p-4 md:p-10 hidden" id="resultsSection">
                <button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-full mb-6 hover:bg-gray-600 transition-colors" onclick="showSearchSection()">
                    <i class="fas fa-arrow-left"></i> กลับหน้าค้นหา
                </button>
                
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-semibold text-gray-700">รายงานทรัพย์สินรายบุคคล/ศูนย์ต้นทุน</h2>
                    <p id="statusDateDisplay" class="text-gray-500 mt-1"></p>
                    <div class="text-lg text-gray-600 mt-4" id="resultsInfo"></div>
                </div>
                
                <div class="flex flex-wrap gap-4 justify-center mb-8">
                    <button class="btn-export bg-white text-gray-700 border-2 border-gray-400 font-bold py-2 px-5 rounded-full hover:bg-gray-100 transition-colors" onclick="previewReport()">
                        <i class="fas fa-eye mr-2"></i> ดูตัวอย่าง
                    </button>
                    <button class="btn-export bg-white text-indigo-600 border-2 border-indigo-600 font-bold py-2 px-5 rounded-full hover:bg-indigo-600 hover:text-white transition-colors" onclick="printReport()">
                        <i class="fas fa-print mr-2"></i> พิมพ์รายงาน
                    </button>
                    <button class="btn-export bg-white text-green-600 border-2 border-green-600 font-bold py-2 px-5 rounded-full hover:bg-green-600 hover:text-white transition-colors" onclick="exportToExcel()">
                        <i class="fas fa-file-excel mr-2"></i> Export to Excel
                    </button>
                </div>
                
                <div class="mb-4 relative">
                    <label for="multifunctionSearchInput" class="sr-only">กรองข้อมูล</label>
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-filter text-gray-400"></i>
                    </div>
                    <input type="text" id="multifunctionSearchInput" class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500" placeholder="กรองข้อมูลในตารางนี้...">
                </div>

                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="w-full text-sm text-left text-gray-600" id="resultsTable">
                        <thead class="text-xs text-white uppercase bg-gradient-to-r from-purple-500 to-indigo-600">
                            <tr>
                                <th scope="col" class="p-4"><input type="checkbox" id="selectAllCheckbox" class="w-4 h-4 accent-indigo-300"></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="assetMain">รหัสทรัพย์สิน <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="assetSub">เลขทรัพย์สินย่อย <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable max-w-sm" data-sort="assetDescription">คำอธิบายทรัพย์สิน <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="transferDate">วันที่โอนเป็นทุน <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 text-right sortable" data-sort="acquisitionValue">มูลค่าการได้มา <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 text-right sortable" data-sort="accumulatedDepreciation">ค่าเสื่อมสะสม <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 text-right sortable" data-sort="bookValue">มูลค่าตามบัญชี <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="assetSupervisorName">ชื่อผู้ดูแล ท/ส <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="assetCostCenter">ศูนย์ต้นทุน ท/ส <i class="fas fa-sort sort-icon"></i></th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                        <tfoot id="resultsFooter" class="font-bold text-gray-700 bg-gray-100">
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <footer class="text-center text-white mt-12 pb-4 text-base">
            <p>ออกแบบและพัฒนาระบบโดย ผบส.กบฟ.(ก3)</p>
        </footer>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-800">ตัวอย่างก่อนพิมพ์</h2>
                <button id="closePreviewModal" class="modal-close text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <iframe id="previewFrame"></iframe>
        </div>
    </div>

    <!-- Excel Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // ========================================
        // Google Sheets API Configuration
        // ========================================
        
        const API_KEY = 'AIzaSyA5c8JZsxEC7JgLspIjuCU-CCsIAa7TtWg';
        const SHEET_ID = '15nHQmmivX-8UaVFZ_DEsupVP1X0MEIfVWQ0oatmFjDM';
        const SHEET_NAME = 'Data';
        const DATA_RANGE = `${SHEET_NAME}!A2:Z70000`;
        const DATE_RANGE = `${SHEET_NAME}!Q2`;
        
        // ========================================
        // Column Mapping
        // ========================================
        const COLUMNS = {
            BUSINESS_TYPE: 0,      // Column A
            DEPARTMENT_CODE: 1,    // Column B
            ASSET_COST_CENTER: 2,  // Column C
            ASSET_MAIN: 3,         // Column D
            ASSET_SUB: 4,          // Column E
            ASSET_DESCRIPTION: 5,  // Column F
            TRANSFER_DATE: 8,      // Column I
            ACQUISITION_VALUE: 9,  // Column J
            DEPRECIATION: 10,      // Column K
            BOOK_VALUE: 11,        // Column L
            EMPLOYEE_CODE: 12,     // Column M
            EMPLOYEE_NAME: 13,     // Column N
            POSITION: 14,          // Column O
            DEPARTMENT: 15         // Column P
        };

        // Global variables
        let currentData = [];
        let currentSearchInfo = {};
        let allData = [];
        let statusDate = '';
        let uniqueCostCenterNames = [];
        let searchTags = [];
        let currentSort = { column: null, direction: 'asc' };

        // ========================================
        // Google Sheets API Functions
        // ========================================
        
        async function loadGoogleSheetsData() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchGet?ranges=${encodeURIComponent(DATA_RANGE)}&ranges=${encodeURIComponent(DATE_RANGE)}&key=${API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Google Sheets API Error:', errorData);
                    throw new Error(`HTTP error! status: ${response.status}. Check console for details.`);
                }
                const data = await response.json();
                
                const mainData = data.valueRanges[0].values;
                const dateData = data.valueRanges[1].values;

                if (!mainData || mainData.length === 0) {
                    throw new Error('No data found in the sheet or the range is empty.');
                }
                
                if (dateData && dateData[0] && dateData[0][0]) {
                    statusDate = dateData[0][0];
                }

                allData = mainData.map((row, index) => {
                    const supervisorName = row[COLUMNS.EMPLOYEE_NAME] === '#N/A' ? '' : row[COLUMNS.EMPLOYEE_NAME];
                    return {
                        id: index, // Add a unique ID for each row
                        businessType: row[COLUMNS.BUSINESS_TYPE] || '',
                        departmentCode: row[COLUMNS.DEPARTMENT_CODE] || '',
                        assetCostCenter: row[COLUMNS.ASSET_COST_CENTER] || '',
                        assetMain: row[COLUMNS.ASSET_MAIN] || '',
                        assetSub: row[COLUMNS.ASSET_SUB] || '',
                        assetDescription: row[COLUMNS.ASSET_DESCRIPTION] || '',
                        transferDate: row[COLUMNS.TRANSFER_DATE] || '',
                        acquisitionValue: row[COLUMNS.ACQUISITION_VALUE] || '',
                        accumulatedDepreciation: row[COLUMNS.DEPRECIATION] || '',
                        bookValue: row[COLUMNS.BOOK_VALUE] || '',
                        employeeCode: row[COLUMNS.EMPLOYEE_CODE] || '',
                        assetSupervisorName: supervisorName || '',
                        position: row[COLUMNS.POSITION] || '',
                        department: row[COLUMNS.DEPARTMENT] || ''
                    };
                }).filter(row => 
                    row.assetMain || row.employeeCode || row.departmentCode
                );
                
                const costCenterNames = allData.map(item => item.assetCostCenter).filter(name => name);
                uniqueCostCenterNames = [...new Set(costCenterNames)];

                console.log(`Loaded ${allData.length} records from Google Sheets`);
                
                return true;
                
            } catch (error) {
                console.error('Error loading Google Sheets data:', error);
                throw error;
            }
        }

        // ========================================
        // Search Functions
        // ========================================
        
        function searchByMultipleCriteria(tags, type) {
            if (tags.length === 0) return [];
            const lowerCaseTags = tags.map(tag => tag.toLowerCase());

            return allData.filter(item => {
                let valueToMatch = '';
                if (type === 'employee') {
                    valueToMatch = item.employeeCode.toString().trim().toLowerCase();
                } else if (type === 'costCenterName') {
                    valueToMatch = item.assetCostCenter.toString().trim().toLowerCase();
                } else if (type === 'businessType') {
                    valueToMatch = item.businessType.toString().trim().toLowerCase();
                } else { // assetNumber
                    valueToMatch = item.assetMain.toString().trim().toLowerCase();
                }
                return lowerCaseTags.includes(valueToMatch);
            });
        }

        // ========================================
        // UI Event Handlers
        // ========================================

        document.querySelectorAll('input[name="searchType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const searchLabel = document.getElementById('searchLabel');
                const searchInput = document.getElementById('searchInput');
                searchTags = [];
                renderTags();
                
                if (this.value === 'employee') {
                    searchLabel.textContent = 'รหัสพนักงาน:';
                    searchInput.placeholder = 'กรอกรหัสแล้วกด Enter เพื่อเพิ่ม';
                } else if (this.value === 'costCenterName') {
                    searchLabel.textContent = 'ชื่อศูนย์ต้นทุน:';
                    searchInput.placeholder = 'พิมพ์เพื่อค้นหาและเลือก';
                } else if (this.value === 'businessType') {
                    searchLabel.textContent = 'ประเภทธุรกิจ:';
                    searchInput.placeholder = 'กรอกประเภทธุรกิจแล้วกด Enter';
                } else { // assetNumber
                    searchLabel.textContent = 'รหัสทรัพย์สิน:';
                    searchInput.placeholder = 'กรอกรหัสทรัพย์สินแล้วกด Enter';
                }
            });
        });

        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (searchTags.length === 0) {
                showError('กรุณาเพิ่มเงื่อนไขการค้นหาอย่างน้อย 1 รายการ');
                return;
            }
            const searchType = document.querySelector('input[name="searchType"]:checked').value;
            await performSearch(searchType, searchTags);
        });

        // ========================================
        // Initialize App
        // ========================================
        
        window.addEventListener('DOMContentLoaded', async function() {
            if (API_KEY === 'YOUR_API_KEY_HERE') {
                showError('กรุณาใส่ API Key ของ Google Sheets ในโค้ด JavaScript ก่อนใช้งาน');
                return;
            }
            
            try {
                showLoading();
                await loadGoogleSheetsData();
                showSearchSection();
                
                setTimeout(() => {
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
                        padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 1000; font-weight: 500;
                    `;
                    successMsg.innerHTML = `<i class="fas fa-check-circle"></i> โหลดข้อมูลสำเร็จ ${allData.length} รายการ`;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                }, 500);
                
            } catch (error) {
                showError('ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้ กรุณาตรวจสอบการตั้งค่า API, Sheet ID, ชื่อ Sheet และการแชร์ไฟล์');
                console.error('Initialization error:', error);
            }
        });

        async function performSearch(searchType, searchValues) {
            showLoading();
            
            try {
                if (allData.length === 0) {
                    await loadGoogleSheetsData();
                }
                
                let filteredData = searchByMultipleCriteria(searchValues, searchType);

                if (filteredData.length === 0) {
                    showNoResults();
                    return;
                }

                currentData = filteredData;
                currentSearchInfo = {
                    type: searchType,
                    value: searchValues.join(', '),
                    data: filteredData[0]
                };

                displayResults(filteredData, searchType);
                
            } catch (error) {
                console.error('Search error:', error);
                showError('เกิดข้อผิดพลาดในการค้นหา กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตและลองใหม่อีกครั้ง');
            }
        }

        function showLoading() {
            document.getElementById('searchSection').style.display = 'block';
            document.getElementById('searchSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('searchSection').classList.remove('hidden');
        }

        function showNoResults() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('noResults').classList.remove('hidden');
            document.getElementById('searchSection').classList.remove('hidden');
        }
        
        function showSearchSection() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('searchSection').classList.remove('hidden');
        }

        function displayResults(data, searchType) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('searchSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            const resultsInfo = document.getElementById('resultsInfo');
            const statusDateDisplay = document.getElementById('statusDateDisplay');

            statusDateDisplay.textContent = statusDate ? `สิ้นสุด ณ งวดบัญชี ${statusDate}` : '';

            if (searchType === 'employee' && searchTags.length === 1) {
                const employee = data.length > 0 ? data[0] : {};
                resultsInfo.innerHTML = `
                    <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2">
                        <div><strong>ชื่อ-สกุล:</strong> ${employee.assetSupervisorName || '-'}</div>
                        <div><strong>ตำแหน่ง:</strong> ${employee.position || '-'}</div>
                        <div><strong>สังกัด:</strong> ${employee.department || '-'}</div>
                    </div>
                `;
            } else {
                resultsInfo.innerHTML = `<strong>ผลการค้นหาสำหรับ:</strong> ${currentSearchInfo.value}`;
            }
            
            renderTable(data);

            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            selectAllCheckbox.checked = false; 
            selectAllCheckbox.addEventListener('change', (event) => {
                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.checked = event.target.checked;
                });
            });
            
            const multifunctionSearchInput = document.getElementById('multifunctionSearchInput');
            multifunctionSearchInput.value = '';
            multifunctionSearchInput.addEventListener('input', () => {
                const searchTerm = multifunctionSearchInput.value.toLowerCase().trim();
                const filteredDisplayData = currentData.filter(item => {
                    return (
                        String(item.assetMain).toLowerCase().includes(searchTerm) ||
                        String(item.assetSub).toLowerCase().includes(searchTerm) ||
                        String(item.assetDescription).toLowerCase().includes(searchTerm) ||
                        String(item.transferDate).toLowerCase().includes(searchTerm) ||
                        formatNumber(item.acquisitionValue).includes(searchTerm) ||
                        formatNumber(item.accumulatedDepreciation).includes(searchTerm) ||
                        formatNumber(item.bookValue).includes(searchTerm) ||
                        String(item.assetSupervisorName).toLowerCase().includes(searchTerm) ||
                        String(item.assetCostCenter).toLowerCase().includes(searchTerm) ||
                        String(item.businessType).toLowerCase().includes(searchTerm)
                    );
                });
                renderTable(filteredDisplayData);
            });
            
            document.querySelectorAll('#resultsTable thead th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    sortAndRenderTable();
                });
            });
        }
        
        function renderTable(dataToRender) {
            const resultsBody = document.getElementById('resultsBody');
            resultsBody.innerHTML = '';

            dataToRender.forEach(item => {
                const row = resultsBody.insertRow();
                row.classList.add('bg-white', 'border-b', 'hover:bg-gray-50');
                row.innerHTML = `
                    <td class="p-4"><input type="checkbox" class="row-checkbox w-4 h-4 accent-indigo-600" data-id="${item.id}"></td>
                    <td class="px-6 py-4">${item.assetMain || '-'}</td>
                    <td class="px-6 py-4">${item.assetSub || '-'}</td>
                    <td class="px-6 py-4 max-w-sm truncate" title="${item.assetDescription || ''}">${item.assetDescription || '-'}</td>
                    <td class="px-6 py-4">${item.transferDate || '-'}</td>
                    <td class="px-6 py-4 text-right">${formatNumber(item.acquisitionValue)}</td>
                    <td class="px-6 py-4 text-right">${formatNumber(item.accumulatedDepreciation)}</td>
                    <td class="px-6 py-4 text-right">${formatNumber(item.bookValue)}</td>
                    <td class="px-6 py-4">${item.assetSupervisorName || '-'}</td>
                    <td class="px-6 py-4">${item.assetCostCenter || '-'}</td>
                `;
            });
            
            calculateAndDisplaySummary(dataToRender);
        }

        function formatNumber(value) {
            if (!value || value === '') return '-';
            const numValue = parseFloat(value.toString().replace(/,/g, ''));
            if (isNaN(numValue)) return value;
            return new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numValue);
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.opacity = 1;
            setTimeout(() => {
                toast.style.opacity = 0;
            }, 3000);
        }

        function getSelectedData() {
            const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                                     .map(cb => parseInt(cb.dataset.id));
            return currentData.filter(item => selectedIds.includes(item.id));
        }
        
        const parseCurrency = (str) => parseFloat(String(str).replace(/,/g, '')) || 0;

        function calculateSummary(data) {
            return data.reduce((summary, item) => {
                summary.count += 1;
                summary.totalAcquisition += parseCurrency(item.acquisitionValue);
                summary.totalDepreciation += parseCurrency(item.accumulatedDepreciation);
                summary.totalBookValue += parseCurrency(item.bookValue);
                return summary;
            }, { count: 0, totalAcquisition: 0, totalDepreciation: 0, totalBookValue: 0 });
        }
        
        function calculateAndDisplaySummary(data) {
            const summary = calculateSummary(data);
            const footer = document.getElementById('resultsFooter');
            footer.innerHTML = `
                <tr>
                    <th class="px-6 py-3">รวม</th>
                    <th class="px-6 py-3" colspan="4">จำนวน ${summary.count} รายการ</th>
                    <th class="px-6 py-3 text-right">${formatNumber(summary.totalAcquisition)}</th>
                    <th class="px-6 py-3 text-right">${formatNumber(summary.totalDepreciation)}</th>
                    <th class="px-6 py-3 text-right">${formatNumber(summary.totalBookValue)}</th>
                    <th class="px-6 py-3" colspan="2"></th>
                </tr>
            `;
        }
        
        // ========================================
        // Tagging & Typeahead Logic
        // ========================================
        const searchInput = document.getElementById('searchInput');
        const suggestionsContainer = document.getElementById('suggestionsContainer');
        const tagContainer = document.getElementById('tagContainer');

        function renderTags() {
            const tags = tagContainer.querySelectorAll('.tag');
            tags.forEach(tag => tag.remove());

            searchTags.forEach(tagValue => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tag';
                tagElement.innerHTML = `
                    <span>${tagValue}</span>
                    <span class="tag-remove" data-value="${tagValue}">&times;</span>
                `;
                tagContainer.insertBefore(tagElement, searchInput);
            });
        }

        function addTag(value) {
            const trimmedValue = value.trim();
            if (trimmedValue && !searchTags.includes(trimmedValue)) {
                searchTags.push(trimmedValue);
                renderTags();
            }
            searchInput.value = '';
            suggestionsContainer.classList.add('hidden');
        }

        tagContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('tag-remove')) {
                const valueToRemove = e.target.dataset.value;
                searchTags = searchTags.filter(tag => tag !== valueToRemove);
                renderTags();
            } else {
                searchInput.focus();
            }
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const searchType = document.querySelector('input[name="searchType"]:checked').value;
                if (searchType !== 'costCenterName') {
                    addTag(searchInput.value);
                }
            }
        });

        searchInput.addEventListener('input', () => {
            const searchType = document.querySelector('input[name="searchType"]:checked').value;
            if (searchType !== 'costCenterName') {
                suggestionsContainer.classList.add('hidden');
                return;
            }

            const inputValue = searchInput.value.toLowerCase();
            if (inputValue.length < 1) {
                suggestionsContainer.classList.add('hidden');
                return;
            }

            const suggestions = uniqueCostCenterNames.filter(name => name.toLowerCase().includes(inputValue));
            
            if (suggestions.length > 0) {
                suggestionsContainer.innerHTML = suggestions
                    .map(s => `<div class="autocomplete-suggestion">${s}</div>`)
                    .join('');
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        });
        
        suggestionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('autocomplete-suggestion')) {
                addTag(e.target.textContent);
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                 suggestionsContainer.classList.add('hidden');
            }
        });

        // ========================================
        // Sorting Logic
        // ========================================
        function sortAndRenderTable() {
            if (!currentSort.column) return;
            
            const sortedData = [...currentData].sort((a, b) => {
                let valA = a[currentSort.column];
                let valB = b[currentSort.column];
                
                const numericColumns = ['acquisitionValue', 'accumulatedDepreciation', 'bookValue', 'assetSub'];
                if (numericColumns.includes(currentSort.column)) {
                    valA = parseCurrency(valA);
                    valB = parseCurrency(valB);
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            renderTable(sortedData);
            updateSortIcons();
        }

        function updateSortIcons() {
            document.querySelectorAll('#resultsTable thead th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                const icon = th.querySelector('.sort-icon');
                icon.classList.remove('fa-sort-up', 'fa-sort-down');
                icon.classList.add('fa-sort');

                if (th.dataset.sort === currentSort.column) {
                    th.classList.add(currentSort.direction);
                    if (currentSort.direction === 'asc') {
                        icon.classList.remove('fa-sort');
                        icon.classList.add('fa-sort-up');
                    } else {
                        icon.classList.remove('fa-sort');
                        icon.classList.add('fa-sort-down');
                    }
                }
            });
        }

        // ========================================
        // Export & Report Functions
        // ========================================
        
        function generateReportHTML() {
             const selectedData = getSelectedData();
            if (selectedData.length === 0) {
                showToast('กรุณาเลือกรายการที่ต้องการ');
                return null;
            }

            const searchType = document.querySelector('input[name="searchType"]:checked').value;
            let tableBodyContent = '';
            
            const generateRows = (data) => data.map(item => `
                <tr>
                    <td>${item.assetMain || '-'}</td>
                    <td>${item.assetSub || '-'}</td>
                    <td>${item.assetDescription || '-'}</td>
                    <td>${item.transferDate || '-'}</td>
                    <td style="text-align: right;">${formatNumber(item.acquisitionValue)}</td>
                    <td style="text-align: right;">${formatNumber(item.accumulatedDepreciation)}</td>
                    <td style="text-align: right;">${formatNumber(item.bookValue)}</td>
                    <td>${item.assetCostCenter || '-'}</td>
                </tr>
            `).join('');

            const generateSummaryRow = (summary, label, style = 'background-color: #f2f2f2;') => `
                <tr style="font-weight: bold; ${style}">
                    <td colspan="4">${label}: ${summary.count} รายการ</td>
                    <td style="text-align: right;">${formatNumber(summary.totalAcquisition)}</td>
                    <td style="text-align: right;">${formatNumber(summary.totalDepreciation)}</td>
                    <td style="text-align: right;">${formatNumber(summary.totalBookValue)}</td>
                    <td></td>
                </tr>
            `;

            if (searchType === 'businessType') {
                const groupedByCostCenter = selectedData.reduce((acc, item) => {
                    const key = item.assetCostCenter || 'ไม่ระบุศูนย์ต้นทุน';
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(item);
                    return acc;
                }, {});

                Object.keys(groupedByCostCenter).sort().forEach(costCenter => {
                    const dataForGroup = groupedByCostCenter[costCenter];
                    tableBodyContent += `<tr><td colspan="8" style="background-color: #e0e7ff; font-weight: bold;">ศูนย์ต้นทุน ท/ส: ${costCenter}</td></tr>`;
                    tableBodyContent += generateRows(dataForGroup);
                    const subSummary = calculateSummary(dataForGroup);
                    tableBodyContent += generateSummaryRow(subSummary, `รวมสำหรับ ${costCenter}`);
                });

                const grandSummary = calculateSummary(selectedData);
                tableBodyContent += generateSummaryRow(grandSummary, 'รวมทั้งหมดทุกรายการ', 'background-color: #d1d5db;');

            } else if (searchTags.length > 1) {
                 searchTags.forEach(tag => {
                    const dataForTag = selectedData.filter(item => {
                        let valueToMatch = '';
                        if (searchType === 'employee') valueToMatch = item.employeeCode;
                        else if (searchType === 'costCenterName') valueToMatch = item.assetCostCenter;
                        else if (searchType === 'assetNumber') valueToMatch = item.assetMain;
                        return valueToMatch.toString().trim().toLowerCase() === tag.toLowerCase();
                    });

                    if (dataForTag.length > 0) {
                        tableBodyContent += `<tr><td colspan="8" style="background-color: #e0e7ff; font-weight: bold;">ผลลัพธ์สำหรับ: ${tag}</td></tr>`;
                        tableBodyContent += generateRows(dataForTag);
                        const subSummary = calculateSummary(dataForTag);
                        tableBodyContent += generateSummaryRow(subSummary, `รวมสำหรับ ${tag}`);
                    }
                });
                
                const grandSummary = calculateSummary(selectedData);
                tableBodyContent += generateSummaryRow(grandSummary, 'รวมทั้งหมดทุกรายการ', 'background-color: #d1d5db;');
            } else {
                tableBodyContent += generateRows(selectedData);
                const summary = calculateSummary(selectedData);
                tableBodyContent += generateSummaryRow(summary, 'รวมทั้งสิ้น');
            }

            let userInfoHtml = '';
            if (currentSearchInfo.type === 'employee' && searchTags.length === 1) {
                const employee = currentData[0];
                userInfoHtml = `
                    <div class="info-grid">
                        <div><strong>ชื่อ-สกุล:</strong> ${employee.assetSupervisorName || '-'}</div>
                        <div><strong>ตำแหน่ง:</strong> ${employee.position || '-'}</div>
                        <div><strong>สังกัด:</strong> ${employee.department || '-'}</div>
                    </div>
                `;
            } else {
                userInfoHtml = `<div><strong>ผลการค้นหาสำหรับ:</strong> ${currentSearchInfo.value}</div>`;
            }
            
            const printDate = new Date().toLocaleDateString('th-TH', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            const reportFooterHtml = `
                <div class="report-footer">
                    <div class="report-source">
                        <div>ข้อมูลจากรายงาน S_ALR_87011963</div>
                        <div>พิมพ์รายงาน ณ วันที่ ${printDate}</div>
                    </div>
                    <div class="signature-section">
                        <div class="signature-box">
                            <div>หน่วยงานในเขต กฟก.3</div>
                            <div class="signature-line">..................................</div>
                            <div>หผ.บส.กบฟ.(ก3)</div>
                        </div>
                        <div class="signature-box">
                            <div>กฟฟ.ในสังกัด กฟก.3</div>
                            <div class="signature-line">..................................</div>
                            <div>หผ.สน.</div>
                        </div>
                    </div>
                </div>
            `;

            return `
                <!DOCTYPE html>
                <html lang="th">
                <head>
                    <title>รายงานยืนยันมูลค่าได้มาและค่าเสื่อมราคา</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
                        body {
                            font-family: 'Sarabun', sans-serif;
                            margin: 20px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                        }
                        h1 { font-size: 18pt; margin: 0; }
                        h2 { font-size: 16pt; margin: 0; font-weight: normal; }
                        h3 { font-size: 14pt; margin: 5px 0 0 0; font-weight: normal; }
                        .info-section {
                            margin-bottom: 20px;
                            font-size: 12pt;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 10px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 10pt;
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 5px;
                            text-align: left;
                        }
                        th {
                            background-color: #f2f2f2;
                            font-weight: bold;
                        }
                        .report-footer {
                            margin-top: 40px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-end;
                            page-break-inside: avoid;
                            width: 100%;
                        }
                        .report-source {
                            font-size: 9pt;
                            color: #555;
                        }
                        .signature-section {
                            display: flex;
                            justify-content: flex-end;
                        }
                        .signature-box {
                            text-align: center;
                            width: 250px;
                            margin-left: 50px;
                        }
                        .signature-line {
                            margin-top: 40px;
                            margin-bottom: 5px;
                        }
                        @media print {
                            @page {
                                size: A4 landscape;
                                margin: 1cm;
                            }
                            body {
                                margin: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>รายงานยืนยันมูลค่าได้มาและค่าเสื่อมราคา</h1>
                        <h2>การไฟฟ้าส่วนภูมิภาค เขต 3 (ภาคกลาง) จังหวัดนครปฐม</h2>
                        <h3>${statusDate ? `สิ้นสุด ณ งวดบัญชี ${statusDate}` : ''}</h3>
                    </div>
                    <div class="info-section">
                        ${userInfoHtml}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>เลขทรัพย์สินหลัก</th>
                                <th>เลขทรัพย์สินย่อย</th>
                                <th>คำอธิบายทรัพย์สิน</th>
                                <th>วันที่โอนเป็นทุน</th>
                                <th>มูลค่าการได้มา</th>
                                <th>ค่าเสื่อมสะสม</th>
                                <th>มูลค่าตามบัญชี</th>
                                <th>ศูนย์ต้นทุน ท/ส</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableBodyContent}
                        </tbody>
                    </table>
                    ${reportFooterHtml}
                </body>
                </html>
            `;
        }

        function previewReport() {
            const reportHtml = generateReportHTML();
            if (reportHtml) {
                const previewFrame = document.getElementById('previewFrame');
                previewFrame.srcdoc = reportHtml;
                document.getElementById('previewModal').classList.add('visible');
            }
        }
        
        document.getElementById('closePreviewModal').addEventListener('click', () => {
             document.getElementById('previewModal').classList.remove('visible');
        });

        function printReport() {
            const reportHtml = generateReportHTML();
            if (reportHtml) {
                 const printWindow = window.open('', '_blank');
                 printWindow.document.write(reportHtml);
                 printWindow.document.close();
                 printWindow.focus();
                 setTimeout(() => {
                     printWindow.print();
                     printWindow.close();
                 }, 250);
            }
        }

        async function exportToPDF() {
            const reportHtml = generateReportHTML();
            if (!reportHtml) return;

            showToast('กำลังสร้างไฟล์ PDF...');

            const printContainer = document.createElement('div');
            printContainer.innerHTML = reportHtml;
            printContainer.style.position = 'absolute';
            printContainer.style.left = '-9999px';
            printContainer.style.width = '1122px'; // A4 landscape width in px for rendering
            document.body.appendChild(printContainer);

            const canvas = await html2canvas(printContainer.querySelector('body'), {
                scale: 2,
                useCORS: true
            });

            document.body.removeChild(printContainer);

            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('l', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = imgWidth / imgHeight;
            const canvasWidth = pdfWidth;
            const canvasHeight = canvasWidth / ratio;

            let heightLeft = canvasHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, canvasWidth, canvasHeight);
            heightLeft -= pdfHeight;

            while (heightLeft > 0) {
                position = heightLeft - canvasHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, canvasWidth, canvasHeight);
                heightLeft -= pdfHeight;
            }
            
            const fileName = `Report Asset - ${searchTags.join(',')}.pdf`;
            pdf.save(fileName);
        }

        function exportToExcel() {
            const selectedData = getSelectedData();
            if (selectedData.length === 0) {
                showToast('กรุณาเลือกรายการที่ต้องการ Export');
                return;
            }

            const excelData = selectedData.map(item => ({
                'เลขทรัพย์สินหลัก': item.assetMain || '-',
                'เลขทรัพย์สินย่อย': item.assetSub || '-',
                'คำอธิบายทรัพย์สิน': item.assetDescription || '-',
                'วันที่โอนเป็นทุน': item.transferDate || '-',
                'มูลค่าการได้มา': parseCurrency(item.acquisitionValue),
                'ค่าเสื่อมสะสม': parseCurrency(item.accumulatedDepreciation),
                'มูลค่าตามบัญชี': parseCurrency(item.bookValue),
                'ชื่อผู้ดูแล ท/ส': item.assetSupervisorName || '-',
                'ศูนย์ต้นทุน ท/ส': item.assetCostCenter || '-',
                'ชื่อผู้ครอบครอง(เบื้องต้น)': item.employeeName || '-',
                'ตำแหน่ง': item.position || '-',
                'สังกัด': item.department || '-'
            }));
            
            const summary = calculateSummary(selectedData);
            const summaryRow = {
                'เลขทรัพย์สินหลัก': `รวมทั้งสิ้น ${summary.count} รายการ`,
                'เลขทรัพย์สินย่อย': '',
                'คำอธิบายทรัพย์สิน': '',
                'วันที่โอนเป็นทุน': '',
                'มูลค่าการได้มา': summary.totalAcquisition,
                'ค่าเสื่อมสะสม': summary.totalDepreciation,
                'มูลค่าตามบัญชี': summary.totalBookValue,
                'ชื่อผู้ดูแล ท/ส': '',
                'ศูนย์ต้นทุน ท/ส': '',
                'ชื่อผู้ครอบครอง(เบื้องต้น)': '',
                'ตำแหน่ง': '',
                'สังกัด': ''
            };
            excelData.push(summaryRow);

            const ws = XLSX.utils.json_to_sheet(excelData);

            ws['!cols'] = [
                { wch: 20 }, { wch: 20 }, { wch: 50 }, { wch: 20 },
                { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 30 }, 
                { wch: 20 }, { wch: 30 }, { wch: 30 }, { wch: 30 }
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Asset Report');
            XLSX.writeFile(wb, 'asset-report.xlsx');
        }
    </script>
</body>
</html>

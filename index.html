<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEAC3 Asset Hub - ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô ‡∏Å‡∏ü‡∏Å.3</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            background-image: linear-gradient(135deg, #a855f7 0%, #3b82f6 100%);
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .text-shadow-lg {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .search-type-container label {
            transition: all 0.2s ease-in-out;
        }
        .search-type-container input:checked + label {
            background-color: #4338ca; /* indigo-700 */
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 0;
            border-radius: 1rem;
            width: 95vw;
            height: 90vh;
            max-width: none;
            max-height: none;
            overflow: hidden;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
         .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f3f4f6;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
         }
        .modal-close {
            cursor: pointer;
        }
        #previewModal iframe, #dashboardModal .modal-body {
            width: 100%;
            height: calc(100% - 57px);
            border: none;
        }
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            cursor: text;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #e0e7ff;
            color: #3730a3;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
        }
        .tag-remove {
            margin-left: 0.5rem;
            cursor: pointer;
            font-weight: bold;
        }
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #d1d5db;
            background-color: white;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 999;
            border-radius: 0 0 0.75rem 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .autocomplete-suggestion {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f3f4f6;
        }
        .sortable {
            cursor: pointer;
        }
        .sortable:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .sort-icon {
            opacity: 0.5;
            margin-left: 5px;
        }
        .sortable.asc .fa-sort-up,
        .sortable.desc .fa-sort-down {
            opacity: 1;
        }
        .quick-filter-btn.active, .db-quick-filter-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .page-link {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            color: #374151;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .page-link:hover {
            background-color: #f3f4f6;
        }
        .page-link.active {
            z-index: 10;
            color: white;
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .page-link.disabled {
            color: #9ca3af;
            pointer-events: none;
            background-color: #f9fafb;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        @media (min-width: 1024px) {
            .chart-container {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center text-white my-8">
            <h1 class="text-4xl sm:text-5xl font-bold mb-2 text-shadow-lg">PEAC3 Asset Hub</h1>
            <p class="text-lg font-medium opacity-90">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô ‡∏Å‡∏ü‡∏Å.3</p>
            <div class="mt-4 inline-block bg-gradient-to-r from-amber-400 to-orange-500 text-white text-sm font-bold px-4 py-2 rounded-full shadow-lg animate-pulse">
                üî• v2.0 "Phoenix"
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-2xl">
            <!-- Search Section -->
            <div class="p-8 sm:p-10 text-center" id="searchSection">
                <h2 class="text-3xl font-semibold text-gray-700 mb-8">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</h2>
                
                <form class="max-w-4xl mx-auto" id="searchForm">
                    <div class="mb-8">
                        <label class="block text-gray-700 font-semibold mb-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                        <div class="search-type-container flex flex-wrap items-center justify-center gap-2 sm:gap-4 p-2 bg-gray-100 rounded-full">
                            <div>
                                <input type="radio" id="assetNumber" name="searchType" value="assetNumber" class="hidden" checked>
                                <label for="assetNumber" class="px-4 py-2 rounded-full cursor-pointer font-semibold text-gray-600">‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</label>
                            </div>
                            <div>
                                <input type="radio" id="employee" name="searchType" value="employee" class="hidden">
                                <label for="employee" class="px-4 py-2 rounded-full cursor-pointer font-semibold text-gray-600">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            </div>
                            <div>
                                <input type="radio" id="costCenterName" name="searchType" value="costCenterName" class="hidden">
                                <label for="costCenterName" class="px-4 py-2 rounded-full cursor-pointer font-semibold text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</label>
                            </div>
                             <div>
                                <input type="radio" id="businessType" name="searchType" value="businessType" class="hidden">
                                <label for="businessType" class="px-4 py-2 rounded-full cursor-pointer font-semibold text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <label for="searchInput" id="searchLabel" class="block text-gray-600 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô:</label>
                        <div class="flex items-start gap-2">
                            <div id="tagContainer" class="tag-container flex-grow">
                                <input type="text" 
                                        id="searchInput" 
                                        class="flex-grow p-2 border-0 focus:outline-none focus:ring-0" 
                                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™, ‡∏ß‡∏≤‡∏á‡∏à‡∏≤‡∏Å Excel, ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á (‡πÄ‡∏ä‡πà‡∏ô 100-105) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter"
                                        autocomplete="off">
                            </div>
                            <button type="button" id="clearAllTagsBtn" title="‡∏•‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" class="hidden mt-2 p-2 text-gray-400 hover:text-red-500 transition-colors">
                                <i class="fas fa-times-circle fa-lg"></i>
                            </button>
                        </div>
                        <div id="suggestionsContainer" class="autocomplete-suggestions hidden"></div>
                    </div>
                    
                    <button type="submit" class="w-full mt-8 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">
                        <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>

                    <div class="text-center mt-6 flex flex-col sm:flex-row justify-center gap-4 sm:gap-8">
                        <a href="https://drive.google.com/uc?export=download&id=1ZRAd6rhUrhiVqqXz0I_d1h_u1kRZxRVS" download="PEAC3_Asset_Hub_Manual.pdf" class="inline-flex items-center justify-center text-sm text-gray-500 hover:text-indigo-600 font-semibold transition-colors duration-300">
                             <i class="fas fa-book-open mr-2"></i>
                             <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                        </a>
                        <a href="https://drive.google.com/uc?export=download&id=1fqrt3u0nHKc9JwJKHDwYMYmqA-feWoJq" download="PEAC3_Asset_Regulations_2568.pdf" class="inline-flex items-center justify-center text-sm text-gray-500 hover:text-indigo-600 font-semibold transition-colors duration-300">
                             <i class="fas fa-file-contract mr-2"></i>
                             <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ø ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</span>
                        </a>
                         </a>
                    </div>
                </form>

                <div class="mt-6 border-t border-gray-200 pt-6">
                    <button id="showGlobalDashboardBtn" class="w-full max-w-md mx-auto bg-gradient-to-r from-blue-500 to-teal-400 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300">
                        <i class="fas fa-tachometer-alt mr-2"></i> Dashboard ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
                    </button>
                </div>

            </div>

            <!-- Loading -->
            <div class="p-10 text-center hidden" id="loading">
                <div class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full text-indigo-500" role="status"></div>
                <p class="mt-4 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>

            <!-- Error Message -->
            <div class="p-4 m-4 bg-red-100 text-red-700 rounded-lg hidden" id="errorMessage"></div>
            
            <!-- Toast Notification -->
            <div id="toast" class="fixed top-5 right-5 bg-yellow-400 text-gray-800 py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 z-50">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>

            <!-- No Results -->
            <div class="p-10 text-center text-gray-500 hidden" id="noResults">
                <i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4"></i>
                <h3 class="text-2xl font-semibold mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
            </div>

            <!-- Results Section -->
            <div class="p-4 md:p-10 hidden" id="resultsSection">
                <button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-full mb-6 hover:bg-gray-600 transition-colors" onclick="showSearchSection()">
                    <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
                
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-semibold text-gray-700">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•/‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</h2>
                    <p id="statusDateDisplay" class="text-gray-500 mt-1"></p>
                    <div class="text-lg text-gray-600 mt-4" id="resultsInfo"></div>
                </div>
                
                <div class="flex flex-wrap gap-4 justify-center mb-8">
                    <button class="btn-export bg-white text-blue-600 border-2 border-blue-600 font-bold py-2 px-5 rounded-full hover:bg-blue-600 hover:text-white transition-colors" onclick="showDashboard(false)">
                        <i class="fas fa-chart-pie mr-2"></i> üìä ‡∏î‡∏π Dashboard
                    </button>
                    <button class="btn-export bg-white text-gray-700 border-2 border-gray-400 font-bold py-2 px-5 rounded-full hover:bg-gray-100 transition-colors" onclick="previewReport()">
                        <i class="fas fa-eye mr-2"></i> ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                    </button>
                    <button class="btn-export bg-white text-indigo-600 border-2 border-indigo-600 font-bold py-2 px-5 rounded-full hover:bg-indigo-600 hover:text-white transition-colors" onclick="printReport()">
                        <i class="fas fa-print mr-2"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    </button>
                    <button class="btn-export bg-white text-green-600 border-2 border-green-600 font-bold py-2 px-5 rounded-full hover:bg-green-600 hover:text-white transition-colors" onclick="exportToExcel()">
                        <i class="fas fa-file-excel mr-2"></i> Export to Excel
                    </button>
                </div>

                <!-- Disposal Alert -->
                <div id="disposalAlertContainer" class="hidden mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-r-lg shadow-md" role="alert">
                    <!-- Content will be injected by JavaScript -->
                </div>

                <div class="my-6 p-4 bg-gray-50 rounded-lg">
                    <div id="quickFilterContainer" class="flex flex-wrap items-center justify-center gap-3">
                        <span class="font-semibold text-gray-600 mr-2">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô:</span>
                        <button id="filterBtnAll" class="quick-filter-btn px-4 py-1.5 border-2 border-gray-300 text-gray-600 rounded-full text-sm font-semibold hover:bg-gray-200 transition-colors active">
                            ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button id="filterBtnBookValue" class="quick-filter-btn px-4 py-1.5 border-2 border-gray-300 text-gray-600 rounded-full text-sm font-semibold hover:bg-gray-200 transition-colors">
                            ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ 1 ‡∏ö‡∏≤‡∏ó
                        </button>
                        <button id="filterBtnDamaged" class="quick-filter-btn px-4 py-1.5 border-2 border-gray-300 text-gray-600 rounded-full text-sm font-semibold hover:bg-gray-200 transition-colors">
                            ‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        </button>
                        <button id="filterBtnDisposed" class="quick-filter-btn px-4 py-1.5 border-2 border-gray-300 text-gray-600 rounded-full text-sm font-semibold hover:bg-gray-200 transition-colors">
                            ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢(‡∏Ç‡∏≤‡∏¢/‡∏ó‡∏≥‡∏•‡∏≤‡∏¢)
                        </button>
                    </div>
                </div>
                
                <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                    <div id="assetClassFilterContainer" class="relative">
                         <button id="assetClassFilterButton" type="button" class="w-full text-left pl-10 pr-10 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 bg-white flex items-center justify-between">
                            <span class="truncate">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                         </button>
                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-layer-group text-gray-400"></i>
                         </div>
                         <div id="assetClassFilterOptions" class="hidden absolute z-10 mt-1 w-full bg-white rounded-md shadow-lg max-h-60 overflow-auto">
                            <!-- Options will be populated here -->
                         </div>
                    </div>
                    <div class="relative">
                        <label for="multifunctionSearchInput" class="sr-only">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-filter text-gray-400"></i>
                        </div>
                        <input type="text" id="multifunctionSearchInput" class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500" placeholder="‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ...">
                    </div>
                </div>

                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="w-full text-sm text-left text-gray-600" id="resultsTable">
                        <thead class="text-xs text-white uppercase bg-gradient-to-r from-indigo-600 to-purple-700">
                            <tr>
                                <th scope="col" class="p-4"><input type="checkbox" id="selectAllCheckbox" class="w-4 h-4 accent-indigo-500"></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="assetMain">‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="assetSub">‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏¢‡πà‡∏≠‡∏¢ <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable max-w-sm" data-sort="assetDescription">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="transferDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏∏‡∏ô <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 text-right sortable" data-sort="acquisitionValue">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏°‡∏≤ <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 text-right sortable" data-sort="accumulatedDepreciation">‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏° <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 text-right sortable" data-sort="bookValue">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="assetSupervisorName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• ‡∏ó/‡∏™ <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="assetCostCenter">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏ó/‡∏™ <i class="fas fa-sort sort-icon"></i></th>
                                <th scope="col" class="px-6 py-3 sortable" data-sort="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <i class="fas fa-sort sort-icon"></i></th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                        <tfoot id="resultsFooter" class="font-bold text-gray-700 bg-gray-100">
                        </tfoot>
                    </table>
                </div>
                 <div id="paginationContainer" class="mt-6 flex justify-center items-center space-x-2 text-sm"></div>
            </div>
        </div>

        <footer class="text-center text-white mt-12 pb-4 text-sm opacity-80">
            <p>‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏ú‡∏ö‡∏™.‡∏Å‡∏ö‡∏ü.(‡∏Å3)</p>
        </footer>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-800">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå</h2>
                <button id="closePreviewModal" class="modal-close text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <iframe id="previewFrame"></iframe>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div id="dashboardModal" class="modal-overlay">
        <div class="modal-content" style="width: 90vw; height: 90vh; max-width: 1200px;">
            <div class="modal-header">
                <h2 id="dashboardTitle" class="text-xl font-bold text-gray-800">Dashboard</h2>
                <button id="closeDashboardModal" class="modal-close text-gray-500 hover:text-gray-800">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div class="modal-body p-6 overflow-y-auto bg-gray-50">
                <!-- Dashboard Filters -->
                <div class="p-4 bg-white rounded-lg shadow mb-6">
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á Dashboard</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <!-- Asset Class Filter (Dropdown) -->
                        <div class="relative">
                            <label for="dbAssetClassFilter" class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</label>
                            <select id="dbAssetClassFilter" class="w-full pl-3 pr-10 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 bg-white">
                                <option value="all">‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            </select>
                        </div>
                        <!-- Business Type Filter (Dropdown) -->
                        <div class="relative">
                            <label for="dbBusinessTypeFilter" class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</label>
                            <select id="dbBusinessTypeFilter" class="w-full pl-3 pr-10 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 bg-white">
                                <option value="all">‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            </select>
                        </div>
                        <!-- Status Filter (Dropdown) -->
                        <div class="relative">
                            <label for="dbStatusFilter" class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</label>
                            <select id="dbStatusFilter" class="w-full pl-3 pr-10 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 bg-white">
                                <option value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            </select>
                        </div>
                    </div>
                    <!-- Quick Filters (Buttons) -->
                    <div id="dbQuickFilterContainer" class="flex flex-wrap items-center justify-center gap-2">
                        <span class="font-semibold text-gray-600 mr-2 text-sm">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô:</span>
                        <button id="dbFilterBtnAll" class="db-quick-filter-btn px-3 py-1 border-2 border-gray-300 text-gray-600 rounded-full text-xs font-semibold transition-colors active">
                            ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button id="dbFilterBtnBookValue" class="db-quick-filter-btn px-3 py-1 border-2 border-gray-300 text-gray-600 rounded-full text-xs font-semibold transition-colors">
                            ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ 1 ‡∏ö‡∏≤‡∏ó
                        </button>
                        <button id="dbFilterBtnDamaged" class="db-quick-filter-btn px-3 py-1 border-2 border-gray-300 text-gray-600 rounded-full text-xs font-semibold transition-colors">
                            ‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        </button>
                        <button id="dbFilterBtnDisposed" class="db-quick-filter-btn px-3 py-1 border-2 border-gray-300 text-gray-600 rounded-full text-xs font-semibold transition-colors">
                            ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢(‡∏Ç‡∏≤‡∏¢/‡∏ó‡∏≥‡∏•‡∏≤‡∏¢)
                        </button>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg text-center shadow">
                        <h3 class="text-sm font-semibold text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (‡∏£‡∏ß‡∏°)</h3>
                        <p id="db-total-count" class="text-2xl font-bold text-blue-600"></p>
                    </div>
                    <div class="bg-white p-4 rounded-lg text-center shadow">
                        <h3 class="text-sm font-semibold text-gray-500">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏°‡∏≤ (‡∏£‡∏ß‡∏°)</h3>
                        <p id="db-total-acquisition" class="text-2xl font-bold text-indigo-600"></p>
                    </div>
                    <div class="bg-white p-4 rounded-lg text-center shadow">
                        <h3 class="text-sm font-semibold text-gray-500">‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏° (‡∏£‡∏ß‡∏°)</h3>
                        <p id="db-total-depreciation" class="text-2xl font-bold text-gray-600"></p>
                    </div>
                    <div class="bg-white p-4 rounded-lg text-center shadow">
                        <h3 class="text-sm font-semibold text-gray-500">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏£‡∏ß‡∏°)</h3>
                        <p id="db-total-bookvalue" class="text-2xl font-bold text-green-600"></p>
                    </div>
                </div>
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-center mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</h3>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-center mb-4">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏™)</h3>
                        <div class="chart-container">
                            <canvas id="classChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow lg:col-span-2">
                        <h3 class="text-lg font-semibold text-center mb-4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô)</h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="costCenterChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // ========================================
        // Google Sheets API Configuration
        // ========================================
        
        const API_KEY = 'AIzaSyA5c8JZsxEC7JgLspIjuCU-CCsIAa7TtWg';
        const SHEET_ID = '15nHQmmivX-8UaVFZ_DEsupVP1X0MEIfVWQ0oatmFjDM';
        const SHEET_NAME = 'Data';
        const DATA_RANGE = `${SHEET_NAME}!A2:Z100000`;
        const DATE_RANGE = `${SHEET_NAME}!Q2`;
        
        // ========================================
        // Column Mapping
        // ========================================
        const COLUMNS = {
            BUSINESS_TYPE: 0,      // Column A
            DEPARTMENT_CODE: 1,    // Column B
            ASSET_COST_CENTER: 2,  // Column C
            ASSET_MAIN: 3,         // Column D
            ASSET_SUB: 4,          // Column E
            ASSET_DESCRIPTION: 5,  // Column F
            TRANSFER_DATE: 8,      // Column I
            ACQUISITION_VALUE: 9,  // Column J
            DEPRECIATION: 10,      // Column K
            BOOK_VALUE: 11,        // Column L
            EMPLOYEE_CODE: 12,     // Column M
            EMPLOYEE_NAME: 13,     // Column N
            POSITION: 14,          // Column O
            DEPARTMENT: 15,        // Column P
            STATUS: 19,            // Column T
            ASSET_CLASS_CODE: 20,  // Column U
            ASSET_CLASS_NAME: 21   // Column V
        };

        // Global variables
        let currentData = [];
        let currentDisplayData = [];
        let selectedIds = new Set();
        let currentSearchInfo = {};
        let allData = [];
        let statusDate = '';
        let uniqueCostCenterNames = [];
        let searchTags = [];
        let currentSort = { column: null, direction: 'asc' };
        let currentPage = 1;
        const rowsPerPage = 20;
        
        let statusChartInstance, classChartInstance, costCenterChartInstance;
        let dashboardBaseData = [];
        let activeDbQuickFilterFn = () => true;
        let activeDbClassFilterValue = 'all';
        let activeDbBizFilterValue = 'all';
        let activeDbStatusFilterValue = 'all';


        // ========================================
        // Google Sheets API Functions
        // ========================================
        
        async function loadGoogleSheetsData() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchGet?ranges=${encodeURIComponent(DATA_RANGE)}&ranges=${encodeURIComponent(DATE_RANGE)}&key=${API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Google Sheets API Error:', errorData);
                    throw new Error(`HTTP error! status: ${response.status}. Check console for details.`);
                }
                const data = await response.json();
                
                const mainData = data.valueRanges[0].values;
                const dateData = data.valueRanges[1].values;

                if (!mainData || mainData.length === 0) {
                    throw new Error('No data found in the sheet or the range is empty.');
                }
                
                if (dateData && dateData[0] && dateData[0][0]) {
                    statusDate = dateData[0][0];
                }

                allData = mainData.map((row, index) => {
                    const supervisorName = row[COLUMNS.EMPLOYEE_NAME] === '#N/A' ? '' : row[COLUMNS.EMPLOYEE_NAME];
                    return {
                        id: index, // Add a unique ID for each row
                        businessType: row[COLUMNS.BUSINESS_TYPE] || '',
                        departmentCode: row[COLUMNS.DEPARTMENT_CODE] || '',
                        assetCostCenter: row[COLUMNS.ASSET_COST_CENTER] || '',
                        assetMain: row[COLUMNS.ASSET_MAIN] || '',
                        assetSub: row[COLUMNS.ASSET_SUB] || '',
                        assetDescription: row[COLUMNS.ASSET_DESCRIPTION] || '',
                        transferDate: row[COLUMNS.TRANSFER_DATE] || '',
                        acquisitionValue: row[COLUMNS.ACQUISITION_VALUE] || '',
                        accumulatedDepreciation: row[COLUMNS.DEPRECIATION] || '',
                        bookValue: row[COLUMNS.BOOK_VALUE] || '',
                        employeeCode: row[COLUMNS.EMPLOYEE_CODE] || '',
                        assetSupervisorName: supervisorName || '',
                        position: row[COLUMNS.POSITION] || '',
                        department: row[COLUMNS.DEPARTMENT] || '',
                        status: row[COLUMNS.STATUS] || '',
                        assetClassCode: row[COLUMNS.ASSET_CLASS_CODE] || '',
                        assetClassName: row[COLUMNS.ASSET_CLASS_NAME] || ''
                    };
                }).filter(row => 
                    row.assetMain || row.employeeCode || row.departmentCode
                );
                
                const costCenterNames = allData.map(item => item.assetCostCenter).filter(name => name);
                uniqueCostCenterNames = [...new Set(costCenterNames)];

                console.log(`Loaded ${allData.length} records from Google Sheets`);
                
                return true;
                
            } catch (error) {
                console.error('Error loading Google Sheets data:', error);
                throw error;
            }
        }

        // ========================================
        // Search Functions
        // ========================================
        
        function searchByMultipleCriteria(tags, type) {
            if (tags.length === 0) return [];

            if (type === 'businessType' && tags.some(tag => tag.toLowerCase() === 'all')) {
                return [...allData];
            }
            
            return allData.filter(item => {
                return tags.some(tag => {
                    const lowerCaseTag = tag.toLowerCase();
                    if (type === 'assetNumber' && lowerCaseTag.includes('-')) {
                        const [startStr, endStr] = lowerCaseTag.split('-');
                        const start = parseInt(startStr.trim(), 10);
                        const end = parseInt(endStr.trim(), 10);
                        const assetValue = parseInt(item.assetMain.trim(), 10);
                        return !isNaN(start) && !isNaN(end) && !isNaN(assetValue) && assetValue >= start && assetValue <= end;
                    } else {
                        let valueToMatch = '';
                        let isContainsSearch = false;
                        
                        if (type === 'employee') valueToMatch = item.employeeCode.toString().trim().toLowerCase();
                        else if (type === 'costCenterName') {
                            valueToMatch = item.assetCostCenter.toString().trim().toLowerCase();
                            isContainsSearch = true; 
                        }
                        else if (type === 'businessType') valueToMatch = item.businessType.toString().trim().toLowerCase();
                        else if (type === 'assetNumber') valueToMatch = item.assetMain.toString().trim().toLowerCase();
                        
                        return isContainsSearch ? valueToMatch.includes(lowerCaseTag) : valueToMatch === lowerCaseTag;
                    }
                });
            });
        }

        // ========================================
        // UI Event Handlers
        // ========================================

        document.querySelectorAll('input[name="searchType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const searchLabel = document.getElementById('searchLabel');
                const searchInput = document.getElementById('searchInput');
                searchTags = [];
                renderTags();
                
                if (this.value === 'employee') {
                    searchLabel.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:';
                    searchInput.placeholder = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏£‡∏∑‡∏≠ 7 ‡∏´‡∏•‡∏±‡∏Å';
                } else if (this.value === 'costCenterName') {
                    searchLabel.textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô:';
                    searchInput.placeholder = '‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏Å‡∏ö‡∏ü." ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                } else if (this.value === 'businessType') {
                    searchLabel.textContent = '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à:';
                    searchInput.placeholder = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™ 4 ‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ "All" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                } else { // assetNumber
                    searchLabel.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô:';
                    searchInput.placeholder = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™, ‡∏ß‡∏≤‡∏á‡∏à‡∏≤‡∏Å Excel, ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á (‡πÄ‡∏ä‡πà‡∏ô 100-105) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter';
                }
            });
        });

        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (searchTags.length === 0) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                return;
            }
            const searchType = document.querySelector('input[name="searchType"]:checked').value;
            await performSearch(searchType, searchTags);
        });

        // ========================================
        // Initialize App
        // ========================================
        
        window.addEventListener('DOMContentLoaded', async function() {
            if (API_KEY.includes('YOUR_FALLBACK_API_KEY')) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á Google Sheets ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î JavaScript ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }
            
            try {
                showLoading();
                await loadGoogleSheetsData();
                showSearchSection();

                document.getElementById('showGlobalDashboardBtn').addEventListener('click', () => {
                    if (allData.length === 0) {
                        showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                        return;
                    }
                    showDashboard(true); // Call dashboard with ALL data
                });
                
                setTimeout(() => {
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
                        padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 1000; font-weight: 500;
                    `;
                    successMsg.innerHTML = `<i class="fas fa-check-circle"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${allData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                }, 500);
                
            } catch (error) {
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API, Sheet ID, ‡∏ä‡∏∑‡πà‡∏≠ Sheet ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå');
                console.error('Initialization error:', error);
            }
        });

        async function performSearch(searchType, searchValues) {
            showLoading();
            
            try {
                if (allData.length === 0) {
                    await loadGoogleSheetsData();
                }
                
                let filteredData = searchByMultipleCriteria(searchValues, searchType);

                if (filteredData.length === 0) {
                    showNoResults();
                    return;
                }
                
                selectedIds.clear(); // Clear selections from previous search
                currentData = filteredData;
                currentSearchInfo = {
                    type: searchType,
                    value: searchValues.join(', '),
                    data: filteredData[0]
                };

                displayResults(filteredData, searchType);
                
            } catch (error) {
                console.error('Search error:', error);
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            }
        }

        function showLoading() {
            document.getElementById('searchSection').style.display = 'block';
            document.getElementById('searchSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('searchSection').classList.remove('hidden');
        }

        function showNoResults() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('noResults').classList.remove('hidden');
            document.getElementById('searchSection').classList.remove('hidden');
        }
        
        function showSearchSection() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('searchSection').classList.remove('hidden');
        }

        function displayResults(data, searchType) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('searchSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            const resultsInfo = document.getElementById('resultsInfo');
            const statusDateDisplay = document.getElementById('statusDateDisplay');

            statusDateDisplay.textContent = statusDate ? `‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡∏ì ‡∏á‡∏ß‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${statusDate}` : '';
            
            if (searchType === 'businessType' && searchTags.includes('All')) {
                currentSort = { column: 'businessType', direction: 'asc' };
                data.sort((a, b) => {
                    const valA = a.businessType || '';
                    const valB = b.businessType || '';
                    return valA.localeCompare(valB, 'th');
                });
            } else {
                currentSort = { column: null, direction: 'asc' };
            }

            if (searchType === 'employee' && searchTags.length === 1) {
                const employee = data.length > 0 ? data[0] : {};
                resultsInfo.innerHTML = `
                    <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2">
                        <div><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> ${employee.assetSupervisorName || '-'}</div>
                        <div><strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${employee.position || '-'}</div>
                        <div><strong>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î:</strong> ${employee.department || '-'}</div>
                    </div>
                `;
            } else {
                resultsInfo.innerHTML = `<strong>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:</strong> ${currentSearchInfo.value}`;
            }
            
            // Disposal Alert Logic
            const disposalAlertContainer = document.getElementById('disposalAlertContainer');
            const disposalItems = data.filter(item => item.status === '‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢(‡∏Ç‡∏≤‡∏¢)' || item.status === '‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢(‡∏ó‡∏≥‡∏•‡∏≤‡∏¢)');

            if (disposalItems.length > 0) {
                disposalAlertContainer.innerHTML = `
                    <div class="flex items-center">
                        <div class="text-2xl mr-4">‚ö†Ô∏è</div>
                        <div>
                            <p class="font-bold">‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${disposalItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                            <p class="text-sm">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏£‡πà‡∏á‡∏£‡∏±‡∏î‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 60 ‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ AA ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö SAP ‡∏ï‡πà‡∏≠‡πÑ‡∏õ</p>
                        </div>
                    </div>
                `;
                disposalAlertContainer.classList.remove('hidden');
            } else {
                disposalAlertContainer.classList.add('hidden');
            }
            
            currentData = [...data]; // Update currentData to the initial search result
            
            initializeFiltersAndDisplay();

            document.querySelectorAll('#resultsTable thead th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    sortAndRenderPaginatedView();
                });
            });
        }

        function initializeFiltersAndDisplay() {
            populateAssetClassFilter();
            initializeQuickFilters();
            applyAllFilters();
            updateSortIcons();
        }
        
        function renderPaginatedView() {
            const totalPages = Math.ceil(currentDisplayData.length / rowsPerPage);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = currentDisplayData.slice(start, end);

            renderTable(pageData);
            calculateAndDisplaySummary(currentDisplayData);
            renderPaginationControls(totalPages);
            updateSelectAllCheckboxState();
        }

        function renderTable(dataToRender) {
            const resultsBody = document.getElementById('resultsBody');
            resultsBody.innerHTML = '';

            dataToRender.forEach(item => {
                const row = resultsBody.insertRow();
                row.classList.add('bg-white', 'border-b', 'hover:bg-gray-50');
                
                let statusHtml = item.status || '-';
                if (statusHtml === '‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢(‡∏Ç‡∏≤‡∏¢)' || statusHtml === '‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢(‡∏ó‡∏≥‡∏•‡∏≤‡∏¢)') {
                    statusHtml = `<span class="text-red-600 font-semibold">${statusHtml}</span>`;
                }

                row.innerHTML = `
                    <td class="p-4"><input type="checkbox" class="row-checkbox w-4 h-4 accent-indigo-600" data-id="${item.id}" ${selectedIds.has(item.id) ? 'checked' : ''}></td>
                    <td class="px-6 py-4" title="${item.assetClassName || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏≤‡∏™'}">${item.assetMain || '-'}</td>
                    <td class="px-6 py-4">${item.assetSub || '-'}</td>
                    <td class="px-6 py-4 max-w-sm truncate" title="${item.assetDescription || ''}">${item.assetDescription || '-'}</td>
                    <td class="px-6 py-4">${item.transferDate || '-'}</td>
                    <td class="px-6 py-4 text-right">${formatNumber(item.acquisitionValue)}</td>
                    <td class="px-6 py-4 text-right">${formatNumber(item.accumulatedDepreciation)}</td>
                    <td class="px-6 py-4 text-right">${formatNumber(item.bookValue)}</td>
                    <td class="px-6 py-4">${item.assetSupervisorName || '-'}</td>
                    <td class="px-6 py-4">${item.assetCostCenter || '-'}</td>
                    <td class="px-6 py-4">${statusHtml}</td>
                `;
            });
            
            // Add event listeners to the new checkboxes
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    if (e.target.checked) {
                        selectedIds.add(id);
                    } else {
                        selectedIds.delete(id);
                    }
                    updateSelectAllCheckboxState();
                });
            });
            
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            selectAllCheckbox.removeEventListener('change', handleSelectAll);
            selectAllCheckbox.addEventListener('change', handleSelectAll);
        }

        function handleSelectAll(event) {
            const isChecked = event.target.checked;
            const dataToSelect = currentDisplayData; // Select all items in the current filtered/sorted view
            
            dataToSelect.forEach(item => {
                if (isChecked) {
                    selectedIds.add(item.id);
                } else {
                    selectedIds.delete(item.id);
                }
            });
            renderPaginatedView(); // Re-render to show checkbox changes
        }

        function updateSelectAllCheckboxState() {
             const selectAllCheckbox = document.getElementById('selectAllCheckbox');
             const allVisibleIds = new Set(currentDisplayData.map(item => item.id));
             const allVisibleSelected = [...allVisibleIds].every(id => selectedIds.has(id));
             selectAllCheckbox.checked = allVisibleSelected && currentDisplayData.length > 0;
        }


        function renderPaginationControls(totalPages) {
            const container = document.getElementById('paginationContainer');
            container.innerHTML = '';

            if (totalPages <= 1) return;

            let paginationHtml = '';

            paginationHtml += `<button class="page-link rounded-l-lg ${currentPage === 1 ? 'disabled' : ''}" data-page="${currentPage - 1}">&laquo;</button>`;

            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (currentPage <= 3) {
                endPage = Math.min(5, totalPages);
            }
            if (currentPage > totalPages - 3) {
                startPage = Math.max(1, totalPages - 4);
            }
            
            if (startPage > 1) {
                 paginationHtml += `<button class="page-link" data-page="1">1</button>`;
                 if (startPage > 2) {
                    paginationHtml += `<span class="page-link disabled">...</span>`;
                 }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `<button class="page-link ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                     paginationHtml += `<span class="page-link disabled">...</span>`;
                }
                paginationHtml += `<button class="page-link" data-page="${totalPages}">${totalPages}</button>`;
            }

            paginationHtml += `<button class="page-link rounded-r-lg ${currentPage === totalPages ? 'disabled' : ''}" data-page="${currentPage + 1}">&raquo;</button>`;

            container.innerHTML = paginationHtml;

            container.querySelectorAll('.page-link').forEach(button => {
                button.addEventListener('click', (e) => {
                    const newPage = parseInt(e.target.dataset.page);
                    if (newPage && newPage !== currentPage) {
                        currentPage = newPage;
                        renderPaginatedView();
                    }
                });
            });
        }

        function formatNumber(value) {
            if (!value || value === '') return '-';
            const numValue = parseFloat(String(value).replace(/,/g, ''));
            if (isNaN(numValue)) return value;
            return new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numValue);
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.opacity = 1;
            setTimeout(() => {
                toast.style.opacity = 0;
            }, 3000);
        }

        function getSelectedData() {
            // This function now gets data from the global Set of selected IDs
            return allData.filter(item => selectedIds.has(item.id));
        }
        
        const parseCurrency = (str) => parseFloat(String(str).replace(/,/g, '')) || 0;

        function calculateSummary(data) {
            return data.reduce((summary, item) => {
                summary.count += 1;
                summary.totalAcquisition += parseCurrency(item.acquisitionValue);
                summary.totalDepreciation += parseCurrency(item.accumulatedDepreciation);
                summary.totalBookValue += parseCurrency(item.bookValue);
                return summary;
            }, { count: 0, totalAcquisition: 0, totalDepreciation: 0, totalBookValue: 0 });
        }
        
        function calculateAndDisplaySummary(data) {
            const summary = calculateSummary(data);
            const footer = document.getElementById('resultsFooter');
            footer.innerHTML = `
                <tr>
                    <th class="px-6 py-3">‡∏£‡∏ß‡∏°</th>
                    <th class="px-6 py-3" colspan="4">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${summary.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th class="px-6 py-3 text-right">${formatNumber(summary.totalAcquisition)}</th>
                    <th class="px-6 py-3 text-right">${formatNumber(summary.totalDepreciation)}</th>
                    <th class="px-6 py-3 text-right">${formatNumber(summary.totalBookValue)}</th>
                    <th class="px-6 py-3" colspan="3"></th>
                </tr>
            `;
        }
        
        // ========================================
        // Tagging & Typeahead Logic
        // ========================================
        const searchInput = document.getElementById('searchInput');
        const suggestionsContainer = document.getElementById('suggestionsContainer');
        const tagContainer = document.getElementById('tagContainer');
        const clearAllTagsBtn = document.getElementById('clearAllTagsBtn');
        let typingTimer;

        function renderTags() {
            const tags = tagContainer.querySelectorAll('.tag');
            tags.forEach(tag => tag.remove());

            searchTags.forEach(tagValue => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tag';
                tagElement.innerHTML = `
                    <span>${tagValue}</span>
                    <span class="tag-remove" data-value="${tagValue}">&times;</span>
                `;
                tagContainer.insertBefore(tagElement, searchInput);
            });
            
            if (searchTags.length > 0) {
                clearAllTagsBtn.classList.remove('hidden');
            } else {
                clearAllTagsBtn.classList.add('hidden');
            }
        }

        function addTag(value) {
            const trimmedValue = value.trim();
            if (trimmedValue && !searchTags.includes(trimmedValue)) {
                searchTags.push(trimmedValue);
                renderTags();
            }
            searchInput.value = '';
            suggestionsContainer.classList.add('hidden');
        }

        clearAllTagsBtn.addEventListener('click', () => {
            searchTags = [];
            renderTags();
        });
        
        tagContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('tag-remove')) {
                const valueToRemove = e.target.dataset.value;
                searchTags = searchTags.filter(tag => tag !== valueToRemove);
                renderTags();
            } else {
                searchInput.focus();
            }
        });

        searchInput.addEventListener('paste', (e) => {
            const searchType = document.querySelector('input[name="searchType"]:checked').value;
            if (searchType !== 'assetNumber') return;
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const items = pastedText.split(/[\n\t\s]+/).filter(item => item.trim() !== '');
            items.forEach(item => addTag(item.trim()));
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const searchType = document.querySelector('input[name="searchType"]:checked').value;
                const inputValue = searchInput.value.trim();

                if (!inputValue) return;

                if (searchType === 'costCenterName' && inputValue.endsWith('*')) {
                    const prefix = inputValue.slice(0, -1).toLowerCase();
                    if (prefix) {
                        const matchingCenters = uniqueCostCenterNames.filter(name => name.toLowerCase().startsWith(prefix));
                        matchingCenters.forEach(addTag);
                    }
                    searchInput.value = '';
                    suggestionsContainer.classList.add('hidden');
                } else {
                    addTag(inputValue);
                }
            }
        });

        searchInput.addEventListener('input', () => {
            const searchType = document.querySelector('input[name="searchType"]:checked').value;
            const inputValue = searchInput.value;
            const lowerInputValue = inputValue.toLowerCase();
            
            clearTimeout(typingTimer);

            if (searchType === 'employee') {
                if (inputValue.length === 6) {
                    typingTimer = setTimeout(() => {
                        addTag(inputValue);
                    }, 500); // 500ms delay
                } else if (inputValue.length === 7) {
                    addTag(inputValue);
                }
                return;
            }

            if (searchType === 'assetNumber') {
                 if (/^\d{9}-\d{9}$/.test(inputValue)) {
                    addTag(inputValue);
                    return;
                }
            }

            if (searchType === 'businessType') {
                if (lowerInputValue === 'all') {
                    addTag('All');
                    return;
                }
                if (inputValue.length === 4) {
                    addTag(inputValue);
                    return;
                }
            }

            if (searchType === 'costCenterName') {
                 if (lowerInputValue === '‡∏Å‡∏ö‡∏ü.') {
                    const prefix = '‡∏Å‡∏ö‡∏ü.'.toLowerCase();
                    const matchingCenters = uniqueCostCenterNames.filter(name => name.toLowerCase().startsWith(prefix));
                    if(matchingCenters.length > 0) {
                        matchingCenters.forEach(addTag);
                        searchInput.value = '';
                    }
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                
                if (inputValue.includes('*')) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                if (inputValue.length < 1) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }

                const suggestions = uniqueCostCenterNames.filter(name => name.toLowerCase().includes(lowerInputValue));
                
                if (suggestions.length > 0) {
                    suggestionsContainer.innerHTML = suggestions
                        .map(s => `<div class="autocomplete-suggestion">${s}</div>`)
                        .join('');
                    suggestionsContainer.classList.remove('hidden');
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        });
        
        suggestionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('autocomplete-suggestion')) {
                addTag(e.target.textContent);
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                 suggestionsContainer.classList.add('hidden');
            }
        });

        // ========================================
        // Sorting Logic
        // ========================================
        function sortAndRenderPaginatedView() {
            if (!currentSort.column) {
                renderPaginatedView();
                return;
            };
            
            currentDisplayData.sort((a, b) => {
                let valA = a[currentSort.column];
                let valB = b[currentSort.column];
                
                const numericColumns = ['acquisitionValue', 'accumulatedDepreciation', 'bookValue', 'assetSub'];
                if (numericColumns.includes(currentSort.column)) {
                    valA = parseCurrency(valA);
                    valB = parseCurrency(valB);
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            currentPage = 1;
            renderPaginatedView();
            updateSortIcons();
        }

        function updateSortIcons() {
            document.querySelectorAll('#resultsTable thead th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                const icon = th.querySelector('.sort-icon');
                icon.classList.remove('fa-sort-up', 'fa-sort-down');
                icon.classList.add('fa-sort');

                if (th.dataset.sort === currentSort.column) {
                    th.classList.add(currentSort.direction);
                    if (currentSort.direction === 'asc') {
                        icon.classList.remove('fa-sort');
                        icon.classList.add('fa-sort-up');
                    } else {
                        icon.classList.remove('fa-sort');
                        icon.classList.add('fa-sort-down');
                    }
                }
            });
        }

        // ========================================
        // Filter Logic
        // ========================================
        let activeQuickFilterFn = () => true;
        let activeClassFilterValue = 'all';

        function populateAssetClassFilter() {
            const optionsContainer = document.getElementById('assetClassFilterOptions');
            const buttonLabel = document.querySelector('#assetClassFilterButton span');
            optionsContainer.innerHTML = ''; // Clear previous options
            buttonLabel.textContent = '‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            
            const allOption = document.createElement('a');
            allOption.href = '#';
            allOption.className = 'block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100';
            allOption.dataset.value = 'all';
            allOption.textContent = '‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            optionsContainer.appendChild(allOption);

            const classes = currentData.reduce((acc, item) => {
                if (item.assetClassCode && item.assetClassName) {
                    acc.set(item.assetClassCode, item.assetClassName);
                }
                return acc;
            }, new Map());
            
            const sortedClasses = [...classes.entries()].sort((a, b) => {
                const numA = parseInt(a[0], 10);
                const numB = parseInt(b[0], 10);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                return a[0].localeCompare(b[0]);
            });

            sortedClasses.forEach(([code, name]) => {
                const option = document.createElement('a');
                option.href = '#';
                option.className = 'block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100';
                option.dataset.value = code;
                option.textContent = `${code} - ${name}`;
                optionsContainer.appendChild(option);
            });
        }
        
        function applyAllFilters() {
             let filtered = [...currentData];
             
             filtered = filtered.filter(activeQuickFilterFn);
             
             if(activeClassFilterValue !== 'all') {
                filtered = filtered.filter(item => item.assetClassCode === activeClassFilterValue);
             }

             const searchTerm = document.getElementById('multifunctionSearchInput').value.toLowerCase().trim();
             if (searchTerm) {
                filtered = filtered.filter(item => {
                    if (searchTerm === '1.00') {
                        return formatNumber(item.bookValue) === '1.00';
                    }
                    return Object.values(item).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                });
             }
             
             currentDisplayData = filtered;
             currentPage = 1;
             renderPaginatedView();
        }

        function initializeQuickFilters() {
            const filterButtons = document.querySelectorAll('.quick-filter-btn');
            const classFilterButton = document.getElementById('assetClassFilterButton');
            const classFilterOptions = document.getElementById('assetClassFilterOptions');
            const multifunctionInput = document.getElementById('multifunctionSearchInput');

            const setActiveButton = (activeBtn) => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                if(activeBtn) activeBtn.classList.add('active');
            };

            filterButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    setActiveButton(e.target);
                    const id = e.target.id;
                    if(id === 'filterBtnAll') activeQuickFilterFn = () => true;
                    else if (id === 'filterBtnBookValue') activeQuickFilterFn = item => formatNumber(item.bookValue) === '1.00';
                    else if (id === 'filterBtnDamaged') activeQuickFilterFn = item => item.status === '‡∏ä‡∏≥‡∏£‡∏∏‡∏î' || item.status === '‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                    else if (id === 'filterBtnDisposed') activeQuickFilterFn = item => item.status === '‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢(‡∏Ç‡∏≤‡∏¢)' || item.status === '‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢(‡∏ó‡∏≥‡∏•‡∏≤‡∏¢)';
                    applyAllFilters();
                });
            });

            classFilterButton.addEventListener('click', () => {
                classFilterOptions.classList.toggle('hidden');
            });

            classFilterOptions.addEventListener('click', (e) => {
                e.preventDefault();
                if (e.target.tagName === 'A') {
                    activeClassFilterValue = e.target.dataset.value;
                    document.querySelector('#assetClassFilterButton span').textContent = e.target.textContent;
                    classFilterOptions.classList.add('hidden');
                    applyAllFilters();
                }
            });

            document.addEventListener('click', (e) => {
                if (!document.getElementById('assetClassFilterContainer').contains(e.target)) {
                    classFilterOptions.classList.add('hidden');
                }
            });

            multifunctionInput.addEventListener('input', () => {
                 setActiveButton(null); // Deselect quick filter when using multifunction search
                 activeQuickFilterFn = () => true; // Reset quick filter function
                 applyAllFilters();
            });
            
            // Reset filters to default state on initialization
            setActiveButton(document.getElementById('filterBtnAll'));
            document.querySelector('#assetClassFilterButton span').textContent = '‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            multifunctionInput.value = '';
            activeQuickFilterFn = () => true;
            activeClassFilterValue = 'all';
        }

        // ========================================
        // Export & Report Functions
        // ========================================
        
        function generateReportHTML() {
            const selectedData = getSelectedData();
            if (selectedData.length === 0) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£');
                return null;
            }
            
            selectedData.sort((a, b) => {
                const valA = a.assetMain.localeCompare(b.assetMain, undefined, {numeric: true});
                if (valA !== 0) return valA;
                return a.assetSub.localeCompare(b.assetSub, undefined, {numeric: true});
            });

            const searchType = document.querySelector('input[name="searchType"]:checked').value;
            let tableBodyHtml = '';

            const generateRows = (data) => data.map(item => `
                <tr>
                    <td>${item.assetMain || '-'}</td>
                    <td>${item.assetSub || '-'}</td>
                    <td>${item.assetDescription || '-'}</td>
                    <td>${item.transferDate || '-'}</td>
                    <td style="text-align: right;">${formatNumber(item.acquisitionValue)}</td>
                    <td style="text-align: right;">${formatNumber(item.accumulatedDepreciation)}</td>
                    <td style="text-align: right;">${formatNumber(item.bookValue)}</td>
                    <td>${item.assetCostCenter || '-'}</td>
                </tr>
            `).join('');

            const generateSummaryRow = (summary, label, isGrandTotal = false) => {
                const style = isGrandTotal 
                    ? 'background-color: #d1d5db; border-top: 2px solid #000;' 
                    : 'background-color: #f0f0f0;';
                return `
                    <tr style="font-weight: bold; ${style}">
                        <td colspan="4">${label}: ${summary.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
                        <td style="text-align: right;">${formatNumber(summary.totalAcquisition)}</td>
                        <td style="text-align: right;">${formatNumber(summary.totalDepreciation)}</td>
                        <td style="text-align: right;">${formatNumber(summary.totalBookValue)}</td>
                        <td></td>
                    </tr>
                `;
            };

            const grandSummary = calculateSummary(selectedData);
            
            if (searchType === 'businessType') {
                const groupedData = selectedData.reduce((acc, item) => {
                    const key = item.assetCostCenter || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(item);
                    return acc;
                }, {});

                Object.keys(groupedData).sort().forEach(key => {
                    const dataForGroup = groupedData[key];
                    tableBodyHtml += `<tr><td colspan="8" style="background-color: #e0e7ff; font-weight: bold;">‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${key}</td></tr>`;
                    tableBodyHtml += generateRows(dataForGroup);
                    const subSummary = calculateSummary(dataForGroup);
                    tableBodyHtml += generateSummaryRow(subSummary, `‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${key}`);
                });
                
                tableBodyHtml += generateSummaryRow(grandSummary, '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', true);

            } else if ((searchType === 'assetNumber' && searchTags.length > 1)) {
                const groupedData = selectedData.reduce((acc, item) => {
                    const key = item.assetCostCenter || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(item);
                    return acc;
                }, {});

                Object.keys(groupedData).sort().forEach(key => {
                    const dataForGroup = groupedData[key];
                    tableBodyHtml += `<tr><td colspan="8" style="background-color: #e0e7ff; font-weight: bold;">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏ó/‡∏™: ${key}</td></tr>`;
                    tableBodyHtml += generateRows(dataForGroup);
                    const subSummary = calculateSummary(dataForGroup);
                    tableBodyHtml += generateSummaryRow(subSummary, `‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${key}`);
                });
                
                tableBodyHtml += generateSummaryRow(grandSummary, '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', true);

            } else if (searchTags.length > 1) {
                searchTags.forEach(tag => {
                    const dataForTag = selectedData.filter(item => {
                        let valueToMatch = '';
                        if (searchType === 'employee') valueToMatch = item.employeeCode;
                        else if (searchType === 'costCenterName') valueToMatch = item.assetCostCenter;
                        
                        if (searchType === 'assetNumber' && tag.includes('-')) {
                            const [startStr, endStr] = tag.split('-');
                            const start = parseInt(startStr, 10);
                            const end = parseInt(endStr, 10);
                            const assetNum = parseInt(item.assetMain, 10);
                            return assetNum >= start && assetNum <= end;
                        }
                        return valueToMatch.toString().trim().toLowerCase() === tag.toLowerCase();
                    });

                    if (dataForTag.length > 0) {
                        tableBodyHtml += `<tr><td colspan="8" style="background-color: #e0e7ff; font-weight: bold;">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${tag}</td></tr>`;
                        tableBodyHtml += generateRows(dataForTag);
                        const subSummary = calculateSummary(dataForTag);
                        tableBodyHtml += generateSummaryRow(subSummary, `‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${tag}`);
                    }
                });
                
                tableBodyHtml += generateSummaryRow(grandSummary, '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', true);

            } else {
                 let rows = generateRows(selectedData);
                 const summaryRow = generateSummaryRow(grandSummary, '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô');
                 tableBodyHtml = `<tbody>${rows}</tbody><tfoot>${summaryRow}</tfoot>`;
            }
            
            let tableContent = tableBodyHtml;


            let userInfoHtml = '';
            if (currentSearchInfo.type === 'employee' && searchTags.length === 1) {
                const employee = currentData.find(item => item.employeeCode.toString().trim().toLowerCase() === searchTags[0].toLowerCase());
                if (employee) {
                    userInfoHtml = `
                        <div class="info-grid">
                            <div><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> ${employee.assetSupervisorName || '-'}</div>
                            <div><strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${employee.position || '-'}</div>
                            <div><strong>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î:</strong> ${employee.department || '-'}</div>
                        </div>
                    `;
                } else {
                     userInfoHtml = `<div><strong>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:</strong> ${currentSearchInfo.value}</div>`;
                }

            } else {
                userInfoHtml = `<div><strong>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:</strong> ${currentSearchInfo.value}</div>`;
            }
            
            const printDate = new Date().toLocaleDateString('th-TH', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            const reportFooterHtml = `
                <div class="report-footer">
                    <div class="report-source">
                        <div>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô S_ALR_87011963</div>
                        <div>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${printDate}</div>
                    </div>
                </div>
            `;

            return `
                <!DOCTYPE html>
                <html lang="th">
                <head>
                    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
                        body {
                            font-family: 'Sarabun', sans-serif;
                            margin: 20px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 20px;
                        }
                        h1 { font-size: 18pt; margin: 0; }
                        h2 { font-size: 16pt; margin: 0; font-weight: normal; }
                        h3 { font-size: 14pt; margin: 5px 0 0 0; font-weight: normal; }
                        .info-section {
                            margin-bottom: 20px;
                            font-size: 12pt;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 10px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 10pt;
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 5px;
                            text-align: left;
                        }
                        th {
                            background-color: #f2f2f2;
                            font-weight: bold;
                        }
                        tbody tr:last-child {
                            page-break-after: auto;
                        }
                        tfoot {
                           display: table-footer-group;
                        }
                        .report-footer {
                            margin-top: 40px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-end;
                            page-break-inside: avoid;
                            width: 100%;
                        }
                        .report-source {
                            font-size: 9pt;
                            color: #555;
                        }
                        @media print {
                            @page {
                                size: A4 landscape;
                                margin: 1cm;
                            }
                            body {
                                margin: 0;
                            }
                            tfoot {
                                display: table-footer-group;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤</h1>
                        <h2>‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ ‡πÄ‡∏Ç‡∏ï 3 (‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á) ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°</h2>
                        <h3>${statusDate ? `‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡∏ì ‡∏á‡∏ß‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ${statusDate}` : ''}</h3>
                    </div>
                    <div class="info-section">
                        ${userInfoHtml}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å</th>
                                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏¢‡πà‡∏≠‡∏¢</th>
                                <th>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏∏‡∏ô</th>
                                <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏°‡∏≤</th>
                                <th>‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°</th>
                                <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                                <th>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏ó/‡∏™</th>
                            </tr>
                        </thead>
                        ${tableContent}
                    </table>
                    ${reportFooterHtml}
                </body>
                </html>
            `;
        }

        function previewReport() {
            const reportHtml = generateReportHTML();
            if (reportHtml) {
                const previewFrame = document.getElementById('previewFrame');
                previewFrame.srcdoc = reportHtml;
                document.getElementById('previewModal').classList.add('visible');
            }
        }
        
        document.getElementById('closePreviewModal').addEventListener('click', () => {
             document.getElementById('previewModal').classList.remove('visible');
        });

        function printReport() {
            const reportHtml = generateReportHTML();
            if (reportHtml) {
                 const printWindow = window.open('', '_blank');
                 printWindow.document.write(reportHtml);
                 printWindow.document.close();
                 printWindow.focus();
                 setTimeout(() => {
                     printWindow.print();
                     printWindow.close();
                 }, 500);
            }
        }

        function exportToExcel() {
            const selectedData = getSelectedData();
            if (selectedData.length === 0) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export');
                return;
            }

            const excelData = selectedData.map(item => ({
                '‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô': item.assetMain || '-',
                '‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏¢‡πà‡∏≠‡∏¢': item.assetSub || '-',
                '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô': item.assetDescription || '-',
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏∏‡∏ô': item.transferDate || '-',
                '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏°‡∏≤': parseCurrency(item.acquisitionValue),
                '‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°': parseCurrency(item.accumulatedDepreciation),
                '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ': parseCurrency(item.bookValue),
                '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• ‡∏ó/‡∏™': item.assetSupervisorName || '-',
                '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏ó/‡∏™': item.assetCostCenter || '-',
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': item.status || '-',
                '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á(‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)': item.employeeName || '-',
                '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á': item.position || '-',
                '‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î': item.department || '-'
            }));
            
            const summary = calculateSummary(selectedData);
            const summaryRow = {
                '‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô': `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ${summary.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                '‡πÄ‡∏•‡∏Ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏¢‡πà‡∏≠‡∏¢': '',
                '‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô': '',
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏∏‡∏ô': '',
                '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏°‡∏≤': summary.totalAcquisition,
                '‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°': summary.totalDepreciation,
                '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ': summary.totalBookValue,
                '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• ‡∏ó/‡∏™': '',
                '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏ó/‡∏™': '',
                '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': '',
                '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á(‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)': '',
                '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á': '',
                '‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î': ''
            };
            excelData.push(summaryRow);

            const ws = XLSX.utils.json_to_sheet(excelData);

            ws['!cols'] = [
                { wch: 20 }, { wch: 20 }, { wch: 50 }, { wch: 20 },
                { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 30 }, 
                { wch: 20 }, { wch: 20 }, { wch: 30 }, { wch: 30 }, { wch: 30 }
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Asset Report');
            XLSX.writeFile(wb, 'asset-report.xlsx');
        }

        // ========================================
        // Dashboard Functions
        // ========================================
        
        document.getElementById('closeDashboardModal').addEventListener('click', () => {
            document.getElementById('dashboardModal').classList.remove('visible');
            if (statusChartInstance) statusChartInstance.destroy();
            if (classChartInstance) classChartInstance.destroy();
            if (costCenterChartInstance) costCenterChartInstance.destroy();
        });

        function showDashboard(isGlobal) {
            if (isGlobal) {
                dashboardBaseData = [...allData];
                document.getElementById('dashboardTitle').textContent = 'Dashboard ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£';
            } else {
                dashboardBaseData = [...currentDisplayData];
                document.getElementById('dashboardTitle').textContent = 'Dashboard ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå';
            }
            
            if (dashboardBaseData.length === 0) {
                showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á Dashboard');
                return;
            }

            // 1. Destroy old charts if they exist
            if (statusChartInstance) statusChartInstance.destroy();
            if (classChartInstance) classChartInstance.destroy();
            if (costCenterChartInstance) costCenterChartInstance.destroy();

            // 2. Populate filters
            populateDashboardFilters(dashboardBaseData);

            // 3. Initialize filters
            initializeDashboardFilters();

            // 4. Apply filters and render charts
            applyDashboardFilters();

            // 5. Show the modal
            document.getElementById('dashboardModal').classList.add('visible');
        }
        
        function populateDashboardFilters(data) {
            const classFilter = document.getElementById('dbAssetClassFilter');
            const bizFilter = document.getElementById('dbBusinessTypeFilter');
            const statusFilter = document.getElementById('dbStatusFilter');
            
            classFilter.innerHTML = '<option value="all">‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            bizFilter.innerHTML = '<option value="all">‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            statusFilter.innerHTML = '<option value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';

            const classes = new Map();
            const bizTypes = new Set();
            const statuses = new Set();

            data.forEach(item => {
                if (item.assetClassCode && item.assetClassName) {
                    classes.set(item.assetClassCode, item.assetClassName);
                }
                if (item.businessType) bizTypes.add(item.businessType);
                if (item.status) statuses.add(item.status);
            });

            const sortedClasses = [...classes.entries()].sort((a, b) => {
                const numA = parseInt(a[0], 10);
                const numB = parseInt(b[0], 10);
                return (!isNaN(numA) && !isNaN(numB)) ? numA - numB : a[0].localeCompare(b[0]);
            });

            sortedClasses.forEach(([code, name]) => {
                const option = new Option(`${code} - ${name}`, code);
                classFilter.add(option);
            });
            
            [...bizTypes].sort().forEach(type => {
                const option = new Option(type, type);
                bizFilter.add(option);
            });
            
            [...statuses].sort().forEach(status => {
                const option = new Option(status, status);
                statusFilter.add(option);
            });
        }
        
        function initializeDashboardFilters() {
            // Clear old listeners by cloning and replacing nodes
            const dbQuickFilterContainer = document.getElementById('dbQuickFilterContainer');
            const newContainer = dbQuickFilterContainer.cloneNode(true);
            dbQuickFilterContainer.parentNode.replaceChild(newContainer, dbQuickFilterContainer);
            
            const dbClassFilter = document.getElementById('dbAssetClassFilter');
            const newDbClassFilter = dbClassFilter.cloneNode(true);
            dbClassFilter.parentNode.replaceChild(newDbClassFilter, dbClassFilter);
            
            const dbBizFilter = document.getElementById('dbBusinessTypeFilter');
            const newDbBizFilter = dbBizFilter.cloneNode(true);
            dbBizFilter.parentNode.replaceChild(newDbBizFilter, dbBizFilter);
            
            const dbStatusFilter = document.getElementById('dbStatusFilter');
            const newDbStatusFilter = dbStatusFilter.cloneNode(true);
            dbStatusFilter.parentNode.replaceChild(newDbStatusFilter, dbStatusFilter);

            // Add new listeners
            newDbClassFilter.addEventListener('change', (e) => {
                activeDbClassFilterValue = e.target.value;
                applyDashboardFilters();
            });
            
            newDbBizFilter.addEventListener('change', (e) => {
                activeDbBizFilterValue = e.target.value;
                applyDashboardFilters();
            });
            
            newDbStatusFilter.addEventListener('change', (e) => {
                activeDbStatusFilterValue = e.target.value;
                applyDashboardFilters();
            });
            
            const dbFilterButtons = newContainer.querySelectorAll('.db-quick-filter-btn');
            const setActiveDbButton = (activeBtn) => {
                dbFilterButtons.forEach(btn => btn.classList.remove('active'));
                if(activeBtn) activeBtn.classList.add('active');
            };

            dbFilterButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    setActiveDbButton(e.target);
                    const id = e.target.id;
                    if(id === 'dbFilterBtnAll') activeDbQuickFilterFn = () => true;
                    else if (id === 'dbFilterBtnBookValue') activeDbQuickFilterFn = item => formatNumber(item.bookValue) === '1.00';
                    else if (id === 'dbFilterBtnDamaged') activeDbQuickFilterFn = item => item.status === '‡∏ä‡∏≥‡∏£‡∏∏‡∏î' || item.status === '‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                    else if (id === 'dbFilterBtnDisposed') activeDbQuickFilterFn = item => item.status === '‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢(‡∏Ç‡∏≤‡∏¢)' || item.status === '‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢(‡∏ó‡∏≥‡∏•‡∏≤‡∏¢)';
                    applyDashboardFilters();
                });
            });

            // Reset filters to default state on initialization
            setActiveDbButton(newContainer.querySelector('#dbFilterBtnAll'));
            activeDbQuickFilterFn = () => true;
            activeDbClassFilterValue = 'all';
            activeDbBizFilterValue = 'all';
            activeDbStatusFilterValue = 'all';
        }
        
        function applyDashboardFilters() {
            let filtered = [...dashboardBaseData];
            
            // 1. Quick Filters
            filtered = filtered.filter(activeDbQuickFilterFn);
            
            // 2. Dropdown Filters
            if(activeDbClassFilterValue !== 'all') {
                filtered = filtered.filter(item => item.assetClassCode === activeDbClassFilterValue);
            }
            if(activeDbBizFilterValue !== 'all') {
                filtered = filtered.filter(item => item.businessType === activeDbBizFilterValue);
            }
            if(activeDbStatusFilterValue !== 'all') {
                filtered = filtered.filter(item => item.status === activeDbStatusFilterValue);
            }
            
            renderDashboardCharts(filtered);
        }
        
        function renderDashboardCharts(data) {
            // 1. Destroy old charts
            if (statusChartInstance) statusChartInstance.destroy();
            if (classChartInstance) classChartInstance.destroy();
            if (costCenterChartInstance) costCenterChartInstance.destroy();

            // 2. Calculate summary data
            const summary = calculateSummary(data);
            document.getElementById('db-total-count').textContent = summary.count.toLocaleString('th-TH');
            document.getElementById('db-total-acquisition').textContent = formatNumber(summary.totalAcquisition);
            document.getElementById('db-total-depreciation').textContent = formatNumber(summary.totalDepreciation);
            document.getElementById('db-total-bookvalue').textContent = formatNumber(summary.totalBookValue);

            // 3. Create Status Chart (Doughnut)
            const statusData = data.reduce((acc, item) => {
                const status = item.status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            createStatusChart(statusData);

            // 4. Create Class Chart (Bar)
            const classData = data.reduce((acc, item) => {
                const className = item.assetClassName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏™';
                const bookValue = parseCurrency(item.bookValue);
                acc[className] = (acc[className] || 0) + bookValue;
                return acc;
            }, {});
            createClassChart(classData);
            
            // 5. Create Cost Center Chart (Bar)
            const costCenterData = data.reduce((acc, item) => {
                const costCenter = item.assetCostCenter || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                acc[costCenter] = (acc[costCenter] || 0) + 1;
                return acc;
            }, {});
            createCostCenterChart(costCenterData);
        }

        function createStatusChart(data) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            statusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                        data: Object.values(data),
                        backgroundColor: [
                            '#4f46e5', // indigo
                            '#f59e0b', // amber
                            '#dc2626', // red
                            '#10b981', // emerald
                            '#6b7280', // gray
                            '#3b82f6', // blue
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function createClassChart(data) {
            const sortedData = Object.entries(data).sort(([,a],[,b]) => b-a).slice(0, 15); // Top 15
            const ctx = document.getElementById('classChart').getContext('2d');
            classChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(item => item[0]),
                    datasets: [{
                        label: '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ö‡∏≤‡∏ó)',
                        data: sortedData.map(item => item[1]),
                        backgroundColor: '#10b981',
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createCostCenterChart(data) {
            const sortedData = Object.entries(data).sort(([,a],[,b]) => b-a).slice(0, 20); // Top 20
            const ctx = document.getElementById('costCenterChart').getContext('2d');
            costCenterChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(item => item[0]),
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)',
                        data: sortedData.map(item => item[1]),
                        backgroundColor: '#3b82f6',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>


